<?php
/**
 * API ููุดุงุช ุจูุช
 * ูููุน ุฎุงูุฏ ุณุนุฏ ููุงุณุชุดุงุฑุงุช
 */

header('Content-Type: application/json; charset=utf-8');

require_once dirname(__DIR__) . '/includes/init.php';

// ุงูุชุญูู ูู ุทุฑููุฉ ุงูุทูุจ
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    errorResponse('ุทุฑููุฉ ุงูุทูุจ ุบูุฑ ูุณููุญุฉ', [], 405);
}

// ุงูุชุญูู ูู Rate Limiting
$ip = Security::getClientIP();
if (!Security::checkRateLimit($ip, 'chatbot', 50, 3600)) {
    errorResponse('ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููุณููุญ ูู ุงูุทูุจุงุช.', [], 429);
}

// ูุฑุงุกุฉ ุงูุจูุงูุงุช
$input = file_get_contents('php://input');
$data = json_decode($input, true);

if (!$data || !isset($data['message'])) {
    errorResponse('ุฑุณุงูุฉ ูุทููุจุฉ');
}

$message = clean($data['message']);
$sessionId = clean($data['session_id'] ?? session_id());

// ุงูุญุตูู ุนูู ุฑุฏ ุงูุจูุช ุงูุฐูู ุนุจุฑ ูุญุฑู ุงูู AIBrain
require_once SITE_ROOT . '/includes/ai_brain.php';
$brain = new AIBrain();
$response = $brain->chatWithGuest($message, $sessionId);

// ุญูุธ ุงููุญุงุฏุซุฉ
try {
    // ุงูุชุญูู ูู ูุฌูุฏ ูุญุงุฏุซุฉ ุณุงุจูุฉ
    $conversation = db()->fetchOne(
        "SELECT * FROM chatbot_conversations WHERE session_id = ? AND status = 'active'",
        [$sessionId]
    );

    $newMessage = [
        'role' => 'user',
        'content' => $message,
        'timestamp' => date('Y-m-d H:i:s')
    ];

    $botMessage = [
        'role' => 'bot',
        'content' => $response,
        'timestamp' => date('Y-m-d H:i:s')
    ];

    if ($conversation) {
        // ุชุญุฏูุซ ุงููุญุงุฏุซุฉ ุงูููุฌูุฏุฉ
        $messages = json_decode($conversation['messages'], true) ?: [];
        $messages[] = $newMessage;
        $messages[] = $botMessage;

        db()->update('chatbot_conversations', [
            'messages' => json_encode($messages, JSON_UNESCAPED_UNICODE)
        ], 'id = ?', ['id' => $conversation['id']]);
    } else {
        // ุฅูุดุงุก ูุญุงุฏุซุฉ ุฌุฏูุฏุฉ
        db()->insert('chatbot_conversations', [
            'session_id' => $sessionId,
            'messages' => json_encode([$newMessage, $botMessage], JSON_UNESCAPED_UNICODE),
            'status' => 'active',
            'ip_address' => $ip,
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? ''
        ]);
    }

} catch (Exception $e) {
    error_log("Chatbot conversation save error: " . $e->getMessage());
}

successResponse('', ['response' => $response]);

/**
 * ุงูุญุตูู ุนูู ุฑุฏ ุงูุจูุช
 */
function getBotResponse($message) {
    $message = mb_strtolower($message);

    // ููุงุนุฏ ุงูุฑุฏ ุงูุจุณูุทุฉ
    $responses = [
        // ุงูุชุญูุงุช
        ['keywords' => ['ูุฑุญุจุง', 'ุงูุณูุงู', 'ููุง', 'ุงููุง', 'ุตุจุงุญ', 'ูุณุงุก'],
         'response' => 'ูุฑุญุจุงู ุจู! ๐ ุฃูุง ูุณุงุนุฏู ุงูุฑููู ูู ุฎุงูุฏ ุณุนุฏ ููุงุณุชุดุงุฑุงุช. ููู ูููููู ูุณุงุนุฏุชู ุงููููุ'],

        // ุงูุฎุฏูุงุช
        ['keywords' => ['ุฎุฏูุงุช', 'ุงูุฎุฏูุงุช', 'ุฎุฏูุงุชูู', 'ุชูุฏููู', 'ุชูุฏููุง'],
         'response' => 'ููุฏู ูุฌููุนุฉ ุดุงููุฉ ูู ุงูุฎุฏูุงุช ุชุดูู:\n\nโ ุงูุงุณุชุดุงุฑุงุช ุงูุชุณููููุฉ\nโ ุงูุชุญูู ุงูุฑููู\nโ ุจูุงุก ุงููููุฉ ุงูุชุฌุงุฑูุฉ\nโ ุงูุชุฏุฑูุจ ูุงูุชุทููุฑ\n\nููููู ุฒูุงุฑุฉ ุตูุญุฉ ุงูุฎุฏูุงุช ููุนุฑูุฉ ุงููุฒูุฏุ ุฃู ุฃุฎุจุฑูู ุนู ุงูุฎุฏูุฉ ุงูุชู ุชูุชู ุจูุง!'],

        // ุงูุฃุณุนุงุฑ
        ['keywords' => ['ุณุนุฑ', 'ุฃุณุนุงุฑ', 'ุชูููุฉ', 'ูู ุณุนุฑ', 'ุจุงูุฉ', 'ุจุงูุงุช'],
         'response' => 'ูุฏููุง 3 ุจุงูุงุช ุฑุฆูุณูุฉ:\n\n๐ผ ุจุงูุฉ ุงูุงูุทูุงู: 5,000 ุฑ.ุณ/ุดูุฑูุงู\n๐ ุจุงูุฉ ุงูููู: 10,000 ุฑ.ุณ/ุดูุฑูุงู\n๐ข ุจุงูุฉ ุงููุคุณุณุงุช: 25,000 ุฑ.ุณ/ุดูุฑูุงู\n\nููููู ุฒูุงุฑุฉ ุตูุญุฉ ุงูุฃุณุนุงุฑ ููุชูุงุตูู ุงููุงููุฉุ ุฃู ุญุฌุฒ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ ูููุงูุดุฉ ุงุญุชูุงุฌุงุชู.'],

        // ุงูุญุฌุฒ
        ['keywords' => ['ุญุฌุฒ', 'ุงุณุชุดุงุฑุฉ', 'ููุนุฏ', 'ุชูุงุตู', 'ุงุชุตุงู'],
         'response' => 'ุฑุงุฆุน! ููููู ุญุฌุฒ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ ุจุณูููุฉ:\n\n๐ ูู ุฎูุงู ุตูุญุฉ ุงูุชูุงุตู ุนูู ุงููููุน\n๐ ุงูุงุชุตุงู ุนูู: +966 50 000 0000\n๐ฑ ูุงุชุณุงุจ: wa.me/966500000000\n\nุณูุชูุงุตู ูุนู ุฃุญุฏ ุฎุจุฑุงุฆูุง ุฎูุงู 24 ุณุงุนุฉ!'],

        // ุงูุชุดุฎูุต
        ['keywords' => ['ุชุดุฎูุต', 'ุชูููู', 'ุงุฎุชุจุงุฑ', 'ุชุญููู'],
         'response' => 'ูุฏููุง ุฃุฏุงุฉ ุชุดุฎูุต ูุฌุงููุฉ ุชุณุงุนุฏู ูู:\n\n๐ ูุนุฑูุฉ ูุณุชูู ุฌุงูุฒูุชู ุงูุฑูููุฉ\n๐ ุงูุชุดุงู ููุงุท ุงูููุฉ ูุงูุถุนู\n๐ก ุงูุญุตูู ุนูู ุชูุตูุงุช ูุฎุตุตุฉ\n\nุงูุฃุฏุงุฉ ุชุณุชุบุฑู 5 ุฏูุงุฆู ููุท. ุฌุฑุจูุง ุงูุขู!'],

        // ุดูุฑ
        ['keywords' => ['ุดูุฑุง', 'ุดูุฑุงู', 'ูุดููุฑ', 'ููุชู'],
         'response' => 'ุงูุนูู! ๐ ูุณุนุฏูู ูุณุงุนุฏุชู. ูู ููุงู ุฃู ุดูุก ุขุฎุฑ ูููููู ูุณุงุนุฏุชู ุจูุ'],

        // ุงููุฏุงุน
        ['keywords' => ['ูุน ุงูุณูุงูุฉ', 'ูุฏุงุนุง', 'ุจุงู', 'ุงูู ุงูููุงุก'],
         'response' => 'ุดูุฑุงู ูุชูุงุตูู ูุนูุง! ๐ ูุชุทูุน ูุฎุฏูุชู. ูุง ุชุชุฑุฏุฏ ูู ุงูุชูุงุตู ูุนูุง ูู ุฃู ููุช!'],
    ];

    // ุงูุจุญุซ ุนู ุฑุฏ ููุงุณุจ
    foreach ($responses as $rule) {
        foreach ($rule['keywords'] as $keyword) {
            if (mb_strpos($message, $keyword) !== false) {
                return $rule['response'];
            }
        }
    }

    // ุงูุฑุฏ ุงูุงูุชุฑุงุถู
    return 'ุดูุฑุงู ูุฑุณุงูุชู! ๐ ุณุฃุญุฑุต ุนูู ุชูุฌููู ูููุณุงุนุฏุฉ ุงูููุงุณุจุฉ.\n\nููููู:\nโข ุทุฑุญ ุณุคุงู ุนู ุฎุฏูุงุชูุง\nโข ุงูุงุณุชูุณุงุฑ ุนู ุงูุฃุณุนุงุฑ\nโข ุญุฌุฒ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ\nโข ุชุฌุฑุจุฉ ุฃุฏุงุฉ ุงูุชุดุฎูุต\n\nุฃู ููููู ุงูุชูุงุตู ูุจุงุดุฑุฉ ูุน ูุฑูููุง ุนุจุฑ ุงููุงุชุณุงุจ.';
}
